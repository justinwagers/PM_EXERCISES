---
title: 'STA 380 Exercises - ABIA'
output: html_document
---
```{r setup, include =FALSE}
library(arules)
library(stats)
library(ggplot2)
library(arulesViz)
library(dichromat)
library(XML)
library(reshape2)
```

# Flights at ABIA
*Visual Story Telling: Create a set of related figures that tell an interesting story about flights into and out of Austin.*

#### Given information about Arrival and Departure Delays, what insights can we gather?
<br>
```{r echo=FALSE}
#read in data file
setwd('~/Documents/STA 380/Exercises')
fly_data = read.csv('ABIA.csv')
attach(fly_data)
#colnames(fly_data)
#dim(fly_data)
```

```{r echo=FALSE, warning=FALSE}
#arrival delay by departure delay
p1 = ggplot(aes(x=DepDelay,y=ArrDelay), data=fly_data)
p1 + geom_point(aes(colour=Distance)) + geom_abline(color='black') + labs(x="Departure Delay (minutes)", y="Arrival Delay (minutes)") + ggtitle("Arrival Delay vs Departure Delay") + theme(plot.title = element_text(hjust = 0.5))
```

First, we plot the relationship between departure and arrival delays. This result shows, not surprisingly, that there is a relationship of approximately y=x. Arrival delays have a tendency to be higher, suggesting in-air delays, such as circling for an available runway on approach. Because arrival delays tend to have a greater influence on flying experience (particularly for connecting flights), we will use arrival delays in our analysis.
<br>
<br>
```{r echo=FALSE, warning = FALSE}
#arrival delay by day of month
p2a = ggplot(aes(x=DayofMonth, y=ArrDelay), data=fly_data)
p2a + geom_point(aes(colour=Distance)) +  stat_summary(fun.y="mean", geom='line', color='black') + labs(x="Day of Month", y="Arrival Delay (mins)") + ggtitle("Delays by Day of the Month") + theme(plot.title = element_text(hjust = 0.5))

#m1 = (aggregate(ArrDelay ~ DayofMonth, fly_data, mean))
#barplot(m1$ArrDelay ~ m1$DayofMonth, xlab='Day of Month', ylab='Average Delay', col='blue4')
```

```{r echo=FALSE, warning = FALSE}
#arrival delay by day of the week
fly_data$DayofWeek[fly_data$DayOfWeek == '1'] = 'Sunday'
fly_data$DayofWeek[fly_data$DayOfWeek == '2'] = 'Monday'
fly_data$DayofWeek[fly_data$DayOfWeek == '3'] = 'Tuesday'
fly_data$DayofWeek[fly_data$DayOfWeek == '4'] = 'Wednesday'
fly_data$DayofWeek[fly_data$DayOfWeek == '5'] = 'Thursday'
fly_data$DayofWeek[fly_data$DayOfWeek == '6'] = 'Friday'
fly_data$DayofWeek[fly_data$DayOfWeek == '7'] = 'Saturday'
fly_data$DayofWeek <- factor(fly_data$DayofWeek,levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

#unique(fly_data$DayofWeek)
#count(fly_data, 'DayofWeek')
fly_d = fly_data[!is.na(fly_data$DayofWeek),]
p2b = ggplot(aes(x=DayofWeek, y=ArrDelay, group = 1), data=fly_d)
p2b + geom_point(aes(colour=Distance)) +  stat_summary(fun.y="mean", geom='line', color='black') + labs(x="Day of Week", y="Arrival Delay (mins)") + ggtitle("Delays by Day of the Week") + theme(plot.title = element_text(hjust = 0.5))

#w1 = (aggregate(ArrDelay ~ DayofWeek, fly_data, mean))
#w2 = qplot(w1$DayOfWeek, w1$ArrDelay, xlab='Day of Week', ylab='Average Delay', col='blue4')
#w2
#barplot(w1$ArrDelay ~ w1$DayofWeek, xlab='Day of Week', ylab='Average Delay', col='blue4')
```

Are there any days you should avoid flying? Arrival delay is plotted against day of the month and day of the week. While there are some slight deviations, the average delay is negligible in either plot (with an overall average of 7.06 mins). Just three days of the month have an average delay over 10 minutes: the 18th, 22nd and 27th. Thursday has the highest average delay at 9.55 minutes.
<br>
<br>
```{r echo=FALSE, warning=FALSE}
#arrival delay by departure time
p3 = ggplot(aes(x=DepTime, y=ArrDelay), data = fly_data)
p3 + geom_point(aes(colour=Distance)) + labs(x="Departure Time (24hr)", y="Arrival Delay (mins)") + ggtitle("Ideal Departure Time") + theme(plot.title = element_text(hjust = 0.5))
```

Next, we look at the best time of day to fly. Intuitively, as the day goes on, delays appear to grow. This follows a common idea that delayed flights in the morning have a domino effect on flights throughout the day. The best time to schedule a flight to avoid a delay is between 5am and 8am.
<br>
<br>
```{r echo = FALSE, warning=FALSE}
fly_dest = fly_data[!(fly_data$Dest == ""),]

#unique(fly_dest$Dest)
#count(fly_dest, 'Dest')

p4 = ggplot(aes(x=Dest, y=ArrDelay), data = fly_dest)
p4 + stat_summary(fun="mean", geom='bar', aes(colour=ArrDelay)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(x="Destination", y="Average Arrival Delay (mins)") + ggtitle("Delays by Destination") + theme(legend.position = "none") + theme(plot.title = element_text(hjust = 0.5))

#DSM bad
#FLL, IND, PHL, SLC, TUL good
#library(plyr)

#dests = ggplot(aes(x=Dest), data = fly_data) +
  #geom_bar(fill='blue4', position='dodge') +
  #ggtitle('Number of Flights by Destination') + 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #labs(x="Destination", y="Number of Flights")
#print(dests)
```

Are there any airports to avoid? Based on average arrival delay, it seems that we should never fly to Des Moines (DSM) as it has the highest average delay by a wide margin. However, upon further inspection, there is only data from a single flight from DSM in the set. 
<br>
<br>
```{r echo = FALSE, warning=FALSE}
df2=fly_dest[!(fly_dest$Dest=="DSM" | fly_dest$Dest=="DTW" | fly_dest$Dest == "ORF"),]

p4b = ggplot(aes(x=Dest, y=ArrDelay), data = df2)
p4b + stat_summary(fun='mean', geom='bar',aes(colour=ArrDelay)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(x="Destination", y="Average Arrival Delay (mins)") + ggtitle("Delays by Destination (Sample > 1)") + theme(plot.title = element_text(hjust = 0.5))
```

Excluding destinations with one flight (DSM, DTW and ORF), New Orleans (MSP) is now the airport with the longest average delay of over 15 minutes. In contrast, flights going into Baltimore (BWI), Fort Lauderdale (FLL), Indianapolis (IND), Philadelphia (PHL), Salt Lake City (SLC), Tulsa (TUL), and Tucson (TUS) all actually arrive ahead of schedule, on average. These are the best airports to fly into if leaving Austin and looking to avoid a delay. 
<br>
<br>
```{r echo = FALSE, warning=FALSE}
fly_data$UniqueCarrier[fly_data$UniqueCarrier == '9E'] = 'Endeavor'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'AA'] = 'American'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'YV'] = 'Mesa'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'NW'] = 'Northwest'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'CO'] = 'Continental'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'XE'] = 'JetSuite'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'B6'] = 'Air Bangladesh'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'WN'] = 'Southwest'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'UA'] = 'United'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'OO'] = 'Skywest'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'OH'] = 'PSA'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'EV'] = 'ExpressJet'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'US'] = 'US Airways'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'MQ'] = 'Envoy Air'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'F9'] = 'Frontier'
fly_data$UniqueCarrier[fly_data$UniqueCarrier == 'DL'] = 'Delta'

#count(fly_data, 'UniqueCarrier')
#unique(fly_data$UniqueCarrier)

#p5 = ggplot(aes(x=UniqueCarrier), data = fly_data) +
  #geom_bar(fill='blue4', position='dodge') +
  #ggtitle('Number of Flights by Carrier') + 
  #labs(x="Carrier Name", y="Number of Flights") + theme(axis.text.x = element_text(angle = 90)) + theme(plot.title = element_text(hjust = 0.5))
#print(p5)

fly_carr = fly_data[!(fly_data$UniqueCarrier == ""),]

#unique(fly_carr$UniqueCarrier)
#count(fly_carr, 'UniqueCarrier')

p8 = ggplot(aes(x=UniqueCarrier, y=ArrDelay), data = fly_carr)
p8 + stat_summary(fun="mean", geom='bar', color='blue4') + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x="Airline", y="Average Arrival Delay (mins)") + ggtitle("Delays by Carrier") + theme(legend.position = "none") + theme(plot.title = element_text(hjust = 0.5))
```

Which carriers are most likely to be delayed? Based on average arrival delay, PSA Airlines is the most likely to be responsible for your missed connection, followed by Delta. On the other end of the spectrum, US Airways is the only carrier that will, on average, get you there ahead of schedule. 
<br>
<br>
```{r echo = FALSE, warning=FALSE}
CarrierDelay <- as.integer(CarrierDelay)
WeatherDelay <- as.integer(WeatherDelay)
NASDelay <- as.integer(NASDelay)
SecurityDelay <- as.integer(SecurityDelay)
LateAircraftDelay <- as.integer(LateAircraftDelay)
CarrierDelay[is.na(CarrierDelay)] = 0
WeatherDelay[is.na(WeatherDelay)] = 0
NASDelay[is.na(NASDelay)] = 0
SecurityDelay[is.na(SecurityDelay)] = 0
LateAircraftDelay[is.na(LateAircraftDelay)] = 0
delays = data.frame(row.names = c('CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay', 'LateAircraftDelay'), 'Total'=c(sum(CarrierDelay), sum(WeatherDelay), sum(NASDelay), sum(SecurityDelay), sum(LateAircraftDelay)))
delay_count = c(sum(CarrierDelay>0), sum(WeatherDelay>0), sum(NASDelay>0), sum(SecurityDelay>0), sum(LateAircraftDelay>0))
delays$delay_count = delay_count
ggplot(delays, aes(x=rownames(delays), y=delay_count)) +
  geom_bar(stat = 'identity', fill='deepskyblue4', colour = 'blue4') +
  ggtitle('Number of Delays Recorded by Type') +
  xlab('Type of Delay') +
  ylab('Number of Delays') + theme(plot.title = element_text(hjust = 0.5))
```

Finally, what's causing all these delays anyway? Clearly, Carrier Delays, Late Aircraft, and NAS (National Aviation System) Delays are the most significant culprits, with Security and Weather Delays relatively infrequent. This can be misleading, however, as NAS delays include all *non-extreme* weather issues, which can be reduced with corrective action by airports or the FAA, among other factors like heavy air traffic and airport operations issues. Weather Delays only refer to rare extreme weather events that cannot be mitigated.
<br>
<br>